name: Reviewer lottery + Discord notify

on:
  pull_request_target:
    types: [opened, ready_for_review, reopened]

# 最小権限で reviewer 付与と通知のみ実行します。
permissions:
  contents: read
  pull-requests: write

jobs:
  assign_and_notify:
    runs-on: ubuntu-latest
    # fork PR では secrets が使えないため、同一リポ内 PR のみ実行します。
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}

    steps:
      # pull_request_target は base 側のコードを checkout するのが安全です。
      - name: Checkout base (safe)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}

      # 2名をランダム選出して reviewer を付与します。
      - name: Assign reviewers (lottery)
        uses: uesteibar/reviewer-lottery@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      # 付与後の reviewer 一覧を API から取得します。
      - name: Fetch PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const number = context.payload.pull_request.number;
            const { data } = await github.rest.pulls.get({ owner, repo, pull_number: number });
            const reviewers = (data.requested_reviewers || []).map(r => r.login);
            core.setOutput('reviewers', reviewers.join(', '));
            core.setOutput('reviewers_count', String(reviewers.length));
            core.setOutput('url', data.html_url);
            core.setOutput('title', data.title);
            core.setOutput('author', data.user.login);
            core.setOutput('draft', String(data.draft));

      # Discord へ通知します。
      # secrets: DISCORD_REVIEW_WEBHOOK_URL を設定してください。
      # repo内に .github/discord-reviewers.json を置くと個人メンションできます。
      - name: Notify Discord (mention assigned reviewers)
        if: ${{ steps.pr.outputs.draft != 'true' && steps.pr.outputs.reviewers_count != '0' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_URL: ${{ steps.pr.outputs.url }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          PR_AUTHOR: ${{ steps.pr.outputs.author }}
          REVIEWERS: ${{ steps.pr.outputs.reviewers }}
        run: |
          url="${DISCORD_WEBHOOK_URL}"
          if [ -z "$url" ]; then
            echo "DISCORD_REVIEW_WEBHOOK_URL is empty; skip."
            exit 0
          fi

          mapping_file=".github/discord-reviewers.json"
          reviewers_raw="${REVIEWERS}"

          if [ -f "$mapping_file" ]; then
            discord_ids=$(echo "$reviewers_raw" | tr ',' '\n' | while read -r r; do
              id=$(jq -r --arg key "$r" '.[$key] // empty' "$mapping_file")
              if [ -n "$id" ]; then
                echo "$id"
              fi
            done)
          else
            discord_ids=""
          fi

          mentions=""
          for id in $discord_ids; do
            mentions="$mentions <@$id>"
          done

          fallback="$reviewers_raw"

          content="$mentions
PR: $PR_URL
Title: $PR_TITLE
Author: $PR_AUTHOR
Reviewers(GitHub): $fallback"

          payload="$(
            jq -n \
              --arg content "$content" \
              --argjson users "$(printf '%s\n' $discord_ids | jq -R . | jq -s .)" \
              --argjson empty_array '[]' \
              '$ARGS.named | {content: .content, allowed_mentions: {users: .users, parse: .empty_array}}'
          )"

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$url"